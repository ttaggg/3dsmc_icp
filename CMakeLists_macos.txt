cmake_minimum_required(VERSION 3.6)

set(CMAKE_CONFIGURATION_TYPES Debug Release CACHE TYPE INTERNAL FORCE)

project(icp)

set(Flann_INCLUDE_DIR /opt/homebrew/Cellar/flann/1.9.2_1)
include_directories(${Flann_INCLUDE_DIR}/include/)
link_directories(${Flann_INCLUDE_DIR}/lib/)

set(FREE_IMAGE_DIR /opt/homebrew/Cellar/freeimage/3.18.0)  
include_directories(${FREE_IMAGE_DIR}/include/)
link_directories(${FREE_IMAGE_DIR}/lib/)

set(LZ4_DIR /opt/homebrew/Cellar/lz4/1.9.4)  
include_directories(${LZ4_DIR}/include/)
link_directories(${LZ4_DIR}/lib/)

set(YAML_CPP_DIR /opt/homebrew/Cellar/yaml-cpp/0.8.0/)
include_directories(${YAML_CPP_DIR}/include/)
link_directories(${YAML_CPP_DIR}/lib/)

# Set C++ flags
set(CMAKE_CXX_STANDARD 14)

set(Open3D_DIR $ENV{HOME}/open3d_install/lib/cmake/Open3D/)
find_package(Open3D REQUIRED)

find_package(Ceres REQUIRED)
find_package(glog REQUIRED)
get_target_property(GLOG_DLL_PATH_DEBUG glog::glog IMPORTED_LOCATION_DEBUG)
get_target_property(GLOG_DLL_PATH_RELEASE glog::glog IMPORTED_LOCATION_RELEASE)

add_definitions("-D_DISABLE_EXTENDED_ALIGNED_STORAGE")

include_directories(include)
include_directories(external/data_utils)

set(HEADER_FILES
    include/Search.h
    include/ProcrustesAligner.h
    include/ICPOptimizer.h
    include/ICPConfiguration.h
    include/DataLoader.h
    include/Utils.h
    include/Evaluator.h
    external/data_utils/Eigen.h
    external/data_utils/SimpleMesh.h
    external/data_utils/PointCloud.h
    external/data_utils/VirtualSensor.h
    external/data_utils/FreeImageHelper.h
)

set(SOURCE_FILES
    src/Search.cpp
    src/ProcrustesAligner.cpp
    src/ICPOptimizer.cpp
    src/ICPConfiguration.cpp
    src/DataLoader.cpp
    src/Utils.cpp
    src/Evaluator.cpp
    external/data_utils/FreeImageHelper.cpp
)


if(Open3D_FOUND)
    add_definitions(-DOPEN3D_ENABLED)
    include_directories(${Open3D_INCLUDE_DIRS})
    link_directories(${Open3D_LIBRARY_DIRS})
    set(OPEN3D_LIBS ${Open3D_LIBRARIES})
else()
    set(OPEN3D_LIBS "")
endif()

add_executable(icp src/main.cpp ${HEADER_FILES} ${SOURCE_FILES})
target_link_libraries(icp ceres freeimage flann Eigen3::Eigen lz4 ${OPEN3D_LIBS} yaml-cpp)
target_include_directories(icp PUBLIC ${Flann_INCLUDE_DIR} ${LZ4_DIR}, ${YAML_CPP_DIR})
